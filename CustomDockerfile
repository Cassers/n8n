# Image size ~ 400MB
FROM node:21-alpine3.18

WORKDIR /app

RUN corepack enable && corepack prepare pnpm@latest --activate
ENV PNPM_HOME=/usr/local/bin

# Instalar n8n globalmente
RUN npm install -g n8n

# Configurar el entorno
ENV PORT=5678
ENV N8N_PORT=$PORT
ENV N8N_METRICS=true
ENV NODE_ENV=production
ENV N8N_PATH=/
ENV N8N_HOST=0.0.0.0
ENV N8N_PROTOCOL=http
ENV N8N_LOG_LEVEL=debug
ENV DEBUG=*

# Configurar permisos y usuario
RUN pnpm install --frozen-lockfile; pnpm run build

USER nodejs
WORKDIR /home/node/.n8n

EXPOSE $PORT

# Usar el binario n8n instalado globalmente
CMD ["pnpm", "run", "start"]